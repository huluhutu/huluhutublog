<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.51" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mister-hope.github.io/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html"><meta property="og:site_name" content="huluhutublog"><meta property="og:title" content="volatile"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-10-06T10:31:37.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:modified_time" content="2022-10-06T10:31:37.000Z"><link rel="icon" href="/huluhutublog/favicon.ico"><link rel="icon" href="/huluhutublog/assets/icon/chrome-mask-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/huluhutublog/assets/icon/chrome-mask-192.png" type="image/png" sizes="192x192"><link rel="icon" href="/huluhutublog/assets/icon/chrome-512.png" type="image/png" sizes="512x512"><link rel="icon" href="/huluhutublog/assets/icon/chrome-192.png" type="image/png" sizes="192x192"><link rel="manifest" href="/huluhutublog/manifest.webmanifest" crossorigin="use-credentials"><meta name="theme-color" content="#46bd87"><link rel="apple-touch-icon" href="/huluhutublog/assets/icon/apple-icon-152.png"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="msapplication-TileImage" content="/huluhutublog/assets/icon/ms-icon-144.png"><meta name="msapplication-TileColor" content="#ffffff"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"><title>volatile | huluhutublog</title><meta name="description" content="That is my Blog!!!">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/huluhutublog/assets/style.dc69c01e.css">
    <link rel="modulepreload" href="/huluhutublog/assets/app.0662e65c.js"><link rel="modulepreload" href="/huluhutublog/assets/4-valatile.html.14b65e88.js"><link rel="modulepreload" href="/huluhutublog/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/huluhutublog/assets/4-valatile.html.60c353d0.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><a href="/huluhutublog/" class="brand"><img class="logo" src="/huluhutublog/logo.svg" alt="huluhutublog"><!----><span class="site-name hide-in-pad">huluhutublog</span></a><!----></div><div class="navbar-center"><!----><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/huluhutublog/" class="nav-link" aria-label="HULUHUTU"><span class="icon iconfont icon-home"></span>HULUHUTU<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="é¢è¯•"><span class="title"><span class="icon iconfont icon-note"></span>é¢è¯•</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Interviews/Java/" class="nav-link" aria-label="Java"><!---->Java<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="è®¡ç®—æœºåŸºç¡€"><span class="title"><span class="icon iconfont icon-note"></span>è®¡ç®—æœºåŸºç¡€</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/DataStructuresAndAlgorithms/" class="nav-link" aria-label="æ•°æ®ç»“æ„ä¸ç®—æ³•"><!---->æ•°æ®ç»“æ„ä¸ç®—æ³•<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/ComputerNetwork/" class="nav-link" aria-label="è®¡ç®—æœºç½‘ç»œ"><!---->è®¡ç®—æœºç½‘ç»œ<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/OperatingSystem/" class="nav-link" aria-label="æ“ä½œç³»ç»Ÿ"><!---->æ“ä½œç³»ç»Ÿ<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/PrinciplesOfComputerOrganization/" class="nav-link" aria-label="è®¡ç®—æœºç»„æˆåŸç†"><!---->è®¡ç®—æœºç»„æˆåŸç†<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/PrinciplesOfDatabase/" class="nav-link" aria-label="æ•°æ®åº“åŸç†"><!---->æ•°æ®åº“åŸç†<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/FundamentalsOfComputerScience/DesignPatterns/" class="nav-link" aria-label="è®¾è®¡æ¨¡å¼"><!---->è®¾è®¡æ¨¡å¼<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Java"><span class="title"><span class="icon iconfont icon-note"></span>Java</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Java/JavaBase/" class="nav-link" aria-label="JavaåŸºç¡€"><!---->JavaåŸºç¡€<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Java/JavaIO/" class="nav-link" aria-label="JavaIO"><!---->JavaIO<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Java/JavaCollection/" class="nav-link" aria-label="Javaé›†åˆ"><!---->Javaé›†åˆ<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Java/JavaConcurrent/" class="nav-link active" aria-label="Javaå¹¶å‘ç¼–ç¨‹"><!---->Javaå¹¶å‘ç¼–ç¨‹<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Java/JVM/JVM.html" class="nav-link" aria-label="JVM"><!---->JVM<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ•°æ®åº“"><span class="title"><span class="icon iconfont icon-note"></span>æ•°æ®åº“</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/DB/MySQL/" class="nav-link" aria-label="MySQL"><!---->MySQL<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/DB/Redis/" class="nav-link" aria-label="Redis"><!---->Redis<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="Spring"><span class="title"><span class="icon iconfont icon-note"></span>Spring</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Spring/Spring/" class="nav-link" aria-label="Spring"><!---->Spring<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Spring/SpringMVC/" class="nav-link" aria-label="SpringMVC"><!---->SpringMVC<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Spring/SpringBoot/" class="nav-link" aria-label="SpringBoot"><!---->SpringBoot<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Spring/SpringCloud/" class="nav-link" aria-label="SpringCloud"><!---->SpringCloud<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="æ¶ˆæ¯é˜Ÿåˆ—"><span class="title"><span class="icon iconfont icon-note"></span>æ¶ˆæ¯é˜Ÿåˆ—</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/MQ/RabbitMQ/" class="nav-link" aria-label="RabbitMQ"><!---->RabbitMQ<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/MQ/RocketMQ/" class="nav-link" aria-label="RocketMQ"><!---->RocketMQ<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/MQ/Kafka/" class="nav-link" aria-label="Kafka"><!---->Kafka<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="åˆ†å¸ƒå¼"><span class="title"><span class="icon iconfont icon-note"></span>åˆ†å¸ƒå¼</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Distributed/Artritecture/" class="nav-link" aria-label="æ¶æ„"><!---->æ¶æ„<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/Distributed/Distributed/" class="nav-link" aria-label="åˆ†å¸ƒå¼ç†è®º"><!---->åˆ†å¸ƒå¼ç†è®º<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="å¼€å‘å·¥å…·"><span class="title"><span class="icon iconfont icon-note"></span>å¼€å‘å·¥å…·</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/DevelopmentTools/Git/" class="nav-link" aria-label="Git"><!---->Git<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/DevelopmentTools/Linux/" class="nav-link" aria-label="Linux"><!---->Linux<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/DevelopmentTools/Docker/" class="nav-link" aria-label="Docker"><!---->Docker<!----></a></li><li class="dropdown-item"><a href="/huluhutublog/pages/DevelopmentTools/Maven/" class="nav-link" aria-label="Maven"><!---->Maven<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="é¡¹ç›®"><span class="title"><span class="icon iconfont icon-note"></span>é¡¹ç›®</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Project/SwiftHome/" class="nav-link" aria-label="å¿«æ·åˆ°å®¶"><!---->å¿«æ·åˆ°å®¶<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" aria-label="éƒ¨ç½²"><span class="title"><span class="icon iconfont icon-note"></span>éƒ¨ç½²</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/huluhutublog/pages/Deploy/Blog/" class="nav-link" aria-label="vuepress"><!---->vuepress<!----></a></li></ul></button></div></div></nav><!----></div><div class="navbar-right"><!----><!----><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><!----><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">JavaåŸºç¡€</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">JavaIO</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">Javaé›†åˆ</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-note"></span><span class="title">Javaå¹¶å‘</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/" class="nav-link sidebar-link sidebar-page" aria-label="Javaå¹¶å‘ç¼–ç¨‹æŒ‡å—"><!---->Javaå¹¶å‘ç¼–ç¨‹æŒ‡å—<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/1-%E5%B9%B6%E5%8F%91%E6%A6%82%E5%BF%B5.html" class="nav-link sidebar-link sidebar-page" aria-label="å¹¶å‘æ¦‚å¿µ"><!---->å¹¶å‘æ¦‚å¿µ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/2-%E7%BA%BF%E7%A8%8B%E5%9F%BA%E6%93%8D.html" class="nav-link sidebar-link sidebar-page" aria-label="çº¿ç¨‹åŸºæ“"><!---->çº¿ç¨‹åŸºæ“<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/3-Synchronized.html" class="nav-link sidebar-link sidebar-page" aria-label="Synchronized"><!---->Synchronized<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="volatile"><!---->volatile<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-volatileçš„ä½¿ç”¨" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1-volatileçš„ä½¿ç”¨"><!---->1-volatileçš„ä½¿ç”¨<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-é˜²é‡æ’åº" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.é˜²é‡æ’åº"><!---->1.é˜²é‡æ’åº<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-å®ç°å¯è§æ€§" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.å®ç°å¯è§æ€§"><!---->2.å®ç°å¯è§æ€§<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_3-ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3.ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™"><!---->3.ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-volatileå®ç°åŸç†" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2-volatileå®ç°åŸç†"><!---->2-volatileå®ç°åŸç†<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-volatile-å¯è§æ€§å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="1.volatile å¯è§æ€§å®ç°"><!---->1.volatile å¯è§æ€§å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-volatile-æœ‰åºæ€§å®ç°" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="2.volatile æœ‰åºæ€§å®ç°"><!---->2.volatile æœ‰åºæ€§å®ç°<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_3-volatileåº”ç”¨åœºæ™¯" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="3-volatileåº”ç”¨åœºæ™¯"><!---->3-volatileåº”ç”¨åœºæ™¯<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—"><!---->æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)"><!---->æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)"><!---->æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼4-volatile-bean-æ¨¡å¼" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼4ï¼švolatile bean æ¨¡å¼"><!---->æ¨¡å¼4ï¼švolatile bean æ¨¡å¼<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥"><!---->æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked"><!---->æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_4-æ€è€ƒ" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="4-æ€è€ƒ"><!---->4-æ€è€ƒ<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/5-final.html" class="nav-link sidebar-link sidebar-page" aria-label="final"><!---->final<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/6-ReentrantLock.html" class="nav-link sidebar-link sidebar-page" aria-label="ReentrantLock"><!---->ReentrantLock<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/7-Condition.html" class="nav-link sidebar-link sidebar-page" aria-label="Condition"><!---->Condition<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/8-LockSupport.html" class="nav-link sidebar-link sidebar-page" aria-label="LockSupport"><!---->LockSupport<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/9-Semaphore.html" class="nav-link sidebar-link sidebar-page" aria-label="Semaphore"><!---->Semaphore<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/10-CountDownLatch.html" class="nav-link sidebar-link sidebar-page" aria-label="CountDownLatch"><!---->CountDownLatch<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/11-CyclicBarrier.html" class="nav-link sidebar-link sidebar-page" aria-label="CyclicBarrier"><!---->CyclicBarrier<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/12-Executor.html" class="nav-link sidebar-link sidebar-page" aria-label="Excutor"><!---->Excutor<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/13-CAS.html" class="nav-link sidebar-link sidebar-page" aria-label="CAS"><!---->CAS<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/14-Unsafe.html" class="nav-link sidebar-link sidebar-page" aria-label="Unsafe"><!---->Unsafe<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/15-%E5%8E%9F%E5%AD%90%E7%B1%BB.html" class="nav-link sidebar-link sidebar-page" aria-label="åŸå­ç±»"><!---->åŸå­ç±»<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/huluhutublog/pages/Java/JavaConcurrent/16-ThreadLocal.html" class="nav-link sidebar-link sidebar-page" aria-label="ThreadLocal"><!---->ThreadLocal<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-note"></span><span class="title">JVM</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->volatile</h1><div class="page-info"><span class="author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://mrhope.site" target="_blank" rel="noopener noreferrer">huluhutu</a></span><span property="author" content="huluhutu"></span></span><!----><span class="date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span>2022å¹´10æœˆ6æ—¥</span><meta property="datePublished" content="2022-10-06T10:31:37.000Z"></span><!----><!----><span class="reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 16 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT16M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">æ­¤é¡µå†…å®¹</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-volatileçš„ä½¿ç”¨" class="router-link-active router-link-exact-active toc-link level2">1-volatileçš„ä½¿ç”¨</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-é˜²é‡æ’åº" class="router-link-active router-link-exact-active toc-link level3">1.é˜²é‡æ’åº</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-å®ç°å¯è§æ€§" class="router-link-active router-link-exact-active toc-link level3">2.å®ç°å¯è§æ€§</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_3-ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" class="router-link-active router-link-exact-active toc-link level3">3.ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-volatileå®ç°åŸç†" class="router-link-active router-link-exact-active toc-link level2">2-volatileå®ç°åŸç†</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_1-volatile-å¯è§æ€§å®ç°" class="router-link-active router-link-exact-active toc-link level3">1.volatile å¯è§æ€§å®ç°</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_2-volatile-æœ‰åºæ€§å®ç°" class="router-link-active router-link-exact-active toc-link level3">2.volatile æœ‰åºæ€§å®ç°</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_3-volatileåº”ç”¨åœºæ™¯" class="router-link-active router-link-exact-active toc-link level2">3-volatileåº”ç”¨åœºæ™¯</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼4-volatile-bean-æ¨¡å¼" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼4ï¼švolatile bean æ¨¡å¼</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" class="router-link-active router-link-exact-active toc-link level3">æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/huluhutublog/pages/Java/JavaConcurrent/4-valatile.html#_4-æ€è€ƒ" class="router-link-active router-link-exact-active toc-link level2">4-æ€è€ƒ</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="volatile" tabindex="-1"><a class="header-anchor" href="#volatile" aria-hidden="true">#</a> volatile</h1><h2 id="_1-volatileçš„ä½¿ç”¨" tabindex="-1"><a class="header-anchor" href="#_1-volatileçš„ä½¿ç”¨" aria-hidden="true">#</a> 1-volatileçš„ä½¿ç”¨</h2><h3 id="_1-é˜²é‡æ’åº" tabindex="-1"><a class="header-anchor" href="#_1-é˜²é‡æ’åº" aria-hidden="true">#</a> 1.é˜²é‡æ’åº</h3><p>æˆ‘ä»¬ä»ä¸€ä¸ªæœ€ç»å…¸çš„ä¾‹å­æ¥åˆ†æé‡æ’åºé—®é¢˜ã€‚å¤§å®¶åº”è¯¥éƒ½å¾ˆç†Ÿæ‚‰å•ä¾‹æ¨¡å¼çš„å®ç°ï¼Œè€Œåœ¨å¹¶å‘ç¯å¢ƒä¸‹çš„å•ä¾‹å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬é€šå¸¸å¯ä»¥é‡‡ç”¨åŒé‡æ£€æŸ¥åŠ é”(DCL)çš„æ–¹å¼æ¥å®ç°ã€‚å…¶æºç å¦‚ä¸‹ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">Singleton</span> singleton<span class="token punctuation">;</span>
    <span class="token doc-comment comment">/**
     * æ„é€ å‡½æ•°ç§æœ‰ï¼Œç¦æ­¢å¤–éƒ¨å®ä¾‹åŒ–
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>singleton<span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>singleton <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    singleton <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> singleton<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç°åœ¨æˆ‘ä»¬åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆè¦åœ¨å˜é‡singletonä¹‹é—´åŠ ä¸Švolatileå…³é”®å­—ã€‚è¦ç†è§£è¿™ä¸ªé—®é¢˜ï¼Œå…ˆè¦äº†è§£å¯¹è±¡çš„æ„é€ è¿‡ç¨‹ï¼Œå®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡å…¶å®å¯ä»¥åˆ†ä¸ºä¸‰ä¸ªæ­¥éª¤ï¼š</p><ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li><li>åˆå§‹åŒ–å¯¹è±¡ã€‚</li><li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li></ul><p>ä½†æ˜¯ç”±äºæ“ä½œç³»ç»Ÿå¯ä»¥<code>å¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åº</code>ï¼Œæ‰€ä»¥ä¸Šé¢çš„è¿‡ç¨‹ä¹Ÿå¯èƒ½ä¼šå˜æˆå¦‚ä¸‹è¿‡ç¨‹ï¼š</p><ul><li>åˆ†é…å†…å­˜ç©ºé—´ã€‚</li><li>å°†å†…å­˜ç©ºé—´çš„åœ°å€èµ‹å€¼ç»™å¯¹åº”çš„å¼•ç”¨ã€‚</li><li>åˆå§‹åŒ–å¯¹è±¡</li></ul><p>å¦‚æœæ˜¯è¿™ä¸ªæµç¨‹ï¼Œå¤šçº¿ç¨‹ç¯å¢ƒä¸‹å°±å¯èƒ½å°†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å¯¹è±¡å¼•ç”¨æš´éœ²å‡ºæ¥ï¼Œä»è€Œå¯¼è‡´ä¸å¯é¢„æ–™çš„ç»“æœã€‚å› æ­¤ï¼Œä¸ºäº†é˜²æ­¢è¿™ä¸ªè¿‡ç¨‹çš„é‡æ’åºï¼Œæˆ‘ä»¬éœ€è¦å°†å˜é‡è®¾ç½®ä¸ºvolatileç±»å‹çš„å˜é‡ã€‚</p><h3 id="_2-å®ç°å¯è§æ€§" tabindex="-1"><a class="header-anchor" href="#_2-å®ç°å¯è§æ€§" aria-hidden="true">#</a> 2.å®ç°å¯è§æ€§</h3><p>å¯è§æ€§é—®é¢˜ä¸»è¦æŒ‡ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å…±äº«å˜é‡å€¼ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹å´çœ‹ä¸åˆ°ã€‚å¼•èµ·å¯è§æ€§é—®é¢˜çš„ä¸»è¦åŸå› æ˜¯æ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€ä¸ªé«˜é€Ÿç¼“å­˜åŒºâ€”â€”çº¿ç¨‹å·¥ä½œå†…å­˜ã€‚volatileå…³é”®å­—èƒ½æœ‰æ•ˆçš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çœ‹ä¸‹ä¸‹é¢çš„ä¾‹å­ï¼Œå°±å¯ä»¥çŸ¥é“å…¶ä½œç”¨ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> b <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        b <span class="token operator">=</span> a<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;b=&quot;</span><span class="token operator">+</span>b<span class="token operator">+</span><span class="token string">&quot;;a=&quot;</span><span class="token operator">+</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">final</span> <span class="token class-name">VolatileTest</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolatileTest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    test<span class="token punctuation">.</span><span class="token function">change</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    test<span class="token punctuation">.</span><span class="token function">print</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç›´è§‚ä¸Šè¯´ï¼Œè¿™æ®µä»£ç çš„ç»“æœåªå¯èƒ½æœ‰ä¸¤ç§ï¼šb=3;a=3 æˆ– b=2;a=1ã€‚ä¸è¿‡è¿è¡Œä¸Šé¢çš„ä»£ç (å¯èƒ½æ—¶é—´ä¸Šè¦é•¿ä¸€ç‚¹)ï¼Œä½ ä¼šå‘ç°é™¤äº†ä¸Šä¸¤ç§ç»“æœä¹‹å¤–ï¼Œè¿˜å‡ºç°äº†å¦å¤–ä¸¤ç§ç»“æœï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> 
b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">1</span>
b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">1</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">1</span> <span class="token comment">// è¿™é‡Œ</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span>
b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">1</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span>
b<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span>
b<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>a<span class="token operator">=</span><span class="token number">3</span> <span class="token comment">// è¿™é‡Œ</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°b=2;a=3å’Œb=3;a=1è¿™ç§ç»“æœå‘¢? æ­£å¸¸æƒ…å†µä¸‹ï¼Œå¦‚æœå…ˆæ‰§è¡Œchangeæ–¹æ³•ï¼Œå†æ‰§è¡Œprintæ–¹æ³•ï¼Œè¾“å‡ºç»“æœåº”è¯¥ä¸ºb=3;a=3ã€‚ç›¸åï¼Œå¦‚æœå…ˆæ‰§è¡Œçš„printæ–¹æ³•ï¼Œå†æ‰§è¡Œchangeæ–¹æ³•ï¼Œç»“æœåº”è¯¥æ˜¯ b=2;a=1ã€‚é‚£b=3;a=1çš„ç»“æœæ˜¯æ€ä¹ˆå‡ºæ¥çš„? <strong>åŸå› å°±æ˜¯ç¬¬ä¸€ä¸ªçº¿ç¨‹å°†å€¼a=3ä¿®æ”¹åï¼Œä½†æ˜¯å¯¹ç¬¬äºŒä¸ªçº¿ç¨‹æ˜¯ä¸å¯è§çš„ï¼Œæ‰€ä»¥æ‰å‡ºç°è¿™ä¸€ç»“æœã€‚å¦‚æœå°†aå’Œbéƒ½æ”¹æˆvolatileç±»å‹çš„å˜é‡å†æ‰§è¡Œï¼Œåˆ™å†ä¹Ÿä¸ä¼šå‡ºç°b=2;a=3å’Œb=3;a=1çš„ç»“æœäº†ã€‚</strong></p><h3 id="_3-ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" tabindex="-1"><a class="header-anchor" href="#_3-ä¿è¯åŸå­æ€§-å•æ¬¡è¯»-å†™" aria-hidden="true">#</a> 3.ä¿è¯åŸå­æ€§:å•æ¬¡è¯»/å†™</h3><p>volatileä¸èƒ½ä¿è¯å®Œå…¨çš„åŸå­æ€§ï¼Œåªèƒ½ä¿è¯å•æ¬¡çš„è¯»/å†™æ“ä½œå…·æœ‰åŸå­æ€§ã€‚å…ˆä»å¦‚ä¸‹ä¸¤ä¸ªé—®é¢˜æ¥ç†è§£ï¼ˆåæ–‡å†ä»å†…å­˜å±éšœçš„è§’åº¦ç†è§£ï¼‰ï¼š</p><h4 id="é—®é¢˜1-i-ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜1-i-ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§" aria-hidden="true">#</a> é—®é¢˜1ï¼š i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§?</h4><p>å¯¹äºåŸå­æ€§ï¼Œéœ€è¦å¼ºè°ƒä¸€ç‚¹ï¼Œä¹Ÿæ˜¯å¤§å®¶å®¹æ˜“è¯¯è§£çš„ä¸€ç‚¹ï¼šå¯¹volatileå˜é‡çš„å•æ¬¡è¯»/å†™æ“ä½œå¯ä»¥ä¿è¯åŸå­æ€§çš„ï¼Œå¦‚longå’Œdoubleç±»å‹å˜é‡ï¼Œä½†æ˜¯å¹¶ä¸èƒ½ä¿è¯i++è¿™ç§æ“ä½œçš„åŸå­æ€§ï¼Œå› ä¸ºæœ¬è´¨ä¸Ši++æ˜¯è¯»ã€å†™ä¸¤æ¬¡æ“ä½œã€‚</p><p>ç°åœ¨æˆ‘ä»¬å°±é€šè¿‡ä¸‹åˆ—ç¨‹åºæ¥æ¼”ç¤ºä¸€ä¸‹è¿™ä¸ªé—®é¢˜ï¼š</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">VolatileTest01</span> <span class="token punctuation">{</span>
    <span class="token keyword">volatile</span> <span class="token keyword">int</span> i<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span>  <span class="token class-name">VolatileTest01</span> test01 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VolatileTest01</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> n <span class="token operator">&lt;</span> <span class="token number">1000</span><span class="token punctuation">;</span> n<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    test01<span class="token punctuation">.</span><span class="token function">addI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//ç­‰å¾…10ç§’ï¼Œä¿è¯ä¸Šé¢ç¨‹åºæ‰§è¡Œå®Œæˆ</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>test01<span class="token punctuation">.</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¤§å®¶å¯èƒ½ä¼šè¯¯è®¤ä¸ºå¯¹å˜é‡iåŠ ä¸Šå…³é”®å­—volatileåï¼Œè¿™æ®µç¨‹åºå°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¤§å®¶å¯ä»¥å°è¯•è¿è¡Œä¸Šé¢çš„ç¨‹åºã€‚ä¸‹é¢æ˜¯æˆ‘æœ¬åœ°è¿è¡Œçš„ç»“æœï¼š981 å¯èƒ½æ¯ä¸ªäººè¿è¡Œçš„ç»“æœä¸ç›¸åŒã€‚ä¸è¿‡åº”è¯¥èƒ½çœ‹å‡ºï¼Œvolatileæ˜¯æ— æ³•ä¿è¯åŸå­æ€§çš„(å¦åˆ™ç»“æœåº”è¯¥æ˜¯1000)ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œi++å…¶å®æ˜¯ä¸€ä¸ªå¤åˆæ“ä½œï¼ŒåŒ…æ‹¬ä¸‰æ­¥éª¤ï¼š</p><ul><li>è¯»å–içš„å€¼ã€‚</li><li>å¯¹iåŠ 1ã€‚</li><li>å°†içš„å€¼å†™å›å†…å­˜ã€‚ volatileæ˜¯æ— æ³•ä¿è¯è¿™ä¸‰ä¸ªæ“ä½œæ˜¯å…·æœ‰åŸå­æ€§çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡AtomicIntegeræˆ–è€…Synchronizedæ¥ä¿è¯+1æ“ä½œçš„åŸå­æ€§ã€‚ æ³¨ï¼šä¸Šé¢å‡ æ®µä»£ç ä¸­å¤šå¤„æ‰§è¡Œäº†Thread.sleep()æ–¹æ³•ï¼Œç›®çš„æ˜¯ä¸ºäº†å¢åŠ å¹¶å‘é—®é¢˜çš„äº§ç”Ÿå‡ ç‡ï¼Œæ— å…¶ä»–ä½œç”¨ã€‚</li></ul><h4 id="é—®é¢˜2-å…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile" tabindex="-1"><a class="header-anchor" href="#é—®é¢˜2-å…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile" aria-hidden="true">#</a> é—®é¢˜2ï¼š å…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile?</h4><p>å› ä¸ºlongå’Œdoubleä¸¤ç§æ•°æ®ç±»å‹çš„æ“ä½œå¯åˆ†ä¸ºé«˜32ä½å’Œä½32ä½ä¸¤éƒ¨åˆ†ï¼Œå› æ­¤æ™®é€šçš„longæˆ–doubleç±»å‹è¯»/å†™å¯èƒ½ä¸æ˜¯åŸå­çš„ã€‚å› æ­¤ï¼Œé¼“åŠ±å¤§å®¶å°†å…±äº«çš„longå’Œdoubleå˜é‡è®¾ç½®ä¸ºvolatileç±»å‹ï¼Œè¿™æ ·èƒ½ä¿è¯ä»»ä½•æƒ…å†µä¸‹å¯¹longå’Œdoubleçš„å•æ¬¡è¯»/å†™æ“ä½œéƒ½å…·æœ‰åŸå­æ€§ã€‚</p><p>å¦‚ä¸‹æ˜¯JLSä¸­çš„è§£é‡Šï¼š</p><blockquote><p>17.7 Non-Atomic Treatment of double and long</p></blockquote><ul><li>For the purposes of the Java programming language memory model, a single write to a non-volatile long or double value is treated as two separate writes: one to each 32-bit half. This can result in a situation where a thread sees the first 32 bits of a 64-bit value from one write, and the second 32 bits from another write.</li><li>Writes and reads of volatile long and double values are always atomic.</li><li>Writes to and reads of references are always atomic, regardless of whether they are implemented as 32-bit or 64-bit values.</li><li>Some implementations may find it convenient to divide a single write action on a 64-bit long or double value into two write actions on adjacent 32-bit values. For efficiencyâ€™s sake, this behavior is implementation-specific; an implementation of the Java Virtual Machine is free to perform writes to long and double values atomically or in two parts.</li><li>Implementations of the Java Virtual Machine are encouraged to avoid splitting 64-bit values where possible. Programmers are encouraged to declare shared 64-bit values as volatile or synchronize their programs correctly to avoid possible complications.</li></ul><p>ç›®å‰å„ç§å¹³å°ä¸‹çš„å•†ç”¨è™šæ‹Ÿæœºéƒ½é€‰æ‹©æŠŠ 64 ä½æ•°æ®çš„è¯»å†™æ“ä½œä½œä¸ºåŸå­æ“ä½œæ¥å¯¹å¾…ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¼–å†™ä»£ç æ—¶ä¸€èˆ¬ä¸æŠŠlong å’Œ double å˜é‡ä¸“é—¨å£°æ˜ä¸º volatileå¤šæ•°æƒ…å†µä¸‹ä¹Ÿæ˜¯ä¸ä¼šé”™çš„ã€‚</p><h2 id="_2-volatileå®ç°åŸç†" tabindex="-1"><a class="header-anchor" href="#_2-volatileå®ç°åŸç†" aria-hidden="true">#</a> 2-volatileå®ç°åŸç†</h2><h3 id="_1-volatile-å¯è§æ€§å®ç°" tabindex="-1"><a class="header-anchor" href="#_1-volatile-å¯è§æ€§å®ç°" aria-hidden="true">#</a> 1.volatile å¯è§æ€§å®ç°</h3><blockquote><p>volatile å˜é‡çš„å†…å­˜å¯è§æ€§æ˜¯åŸºäºå†…å­˜å±éšœ(Memory Barrier)å®ç°:</p></blockquote><ul><li>å†…å­˜å±éšœï¼Œåˆç§°å†…å­˜æ …æ ï¼Œæ˜¯ä¸€ä¸ª CPU æŒ‡ä»¤ã€‚</li><li>åœ¨ç¨‹åºè¿è¡Œæ—¶ï¼Œä¸ºäº†æé«˜æ‰§è¡Œæ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºï¼ŒJMM ä¸ºäº†ä¿è¯åœ¨ä¸åŒçš„ç¼–è¯‘å™¨å’Œ CPU ä¸Šæœ‰ç›¸åŒçš„ç»“æœï¼Œé€šè¿‡æ’å…¥ç‰¹å®šç±»å‹çš„å†…å­˜å±éšœæ¥ç¦æ­¢+ ç‰¹å®šç±»å‹çš„ç¼–è¯‘å™¨é‡æ’åºå’Œå¤„ç†å™¨é‡æ’åºï¼Œæ’å…¥ä¸€æ¡å†…å­˜å±éšœä¼šå‘Šè¯‰ç¼–è¯‘å™¨å’Œ CPUï¼šä¸ç®¡ä»€ä¹ˆæŒ‡ä»¤éƒ½ä¸èƒ½å’Œè¿™æ¡ Memory Barrier æŒ‡ä»¤é‡æ’åºã€‚</li></ul><p>å†™ä¸€æ®µç®€å•çš„ Java ä»£ç ï¼Œå£°æ˜ä¸€ä¸ª volatile å˜é‡ï¼Œå¹¶èµ‹å€¼ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Test</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> a<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Test</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        test<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ hsdis å’Œ jitwatch å·¥å…·å¯ä»¥å¾—åˆ°ç¼–è¯‘åçš„æ±‡ç¼–ä»£ç :</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
  0x0000000002951563: and    <span class="token variable">$0xffffffffffffff87</span>,%rdi
  0x0000000002951567: je     0x00000000029515f8
  0x000000000295156d: <span class="token builtin class-name">test</span>   <span class="token variable">$0x7</span>,%rdi
  0x0000000002951574: jne    0x00000000029515bd
  0x0000000002951576: <span class="token builtin class-name">test</span>   <span class="token variable">$0x300</span>,%rdi
  0x000000000295157d: jne    0x000000000295159c
  0x000000000295157f: and    <span class="token variable">$0x37f</span>,%rax
  0x0000000002951586: mov    %rax,%rdi
  0x0000000002951589: or     %r15,%rdi
  0x000000000295158c: lock cmpxchg %rdi,<span class="token punctuation">(</span>%rdx<span class="token punctuation">)</span>  //åœ¨ volatile ä¿®é¥°çš„å…±äº«å˜é‡è¿›è¡Œå†™æ“ä½œçš„æ—¶å€™ä¼šå¤šå‡º lock å‰ç¼€çš„æŒ‡ä»¤
  0x0000000002951591: jne    0x0000000002951a15
  0x0000000002951597: jmpq   0x00000000029515f8
  0x000000000295159c: mov    0x8<span class="token punctuation">(</span>%rdx<span class="token punctuation">)</span>,%edi
  0x000000000295159f: shl    <span class="token variable">$0x3</span>,%rdi
  0x00000000029515a3: mov    0xa8<span class="token punctuation">(</span>%rdi<span class="token punctuation">)</span>,%rdi
  0x00000000029515aa: or     %r15,%rdi
<span class="token punctuation">..</span><span class="token punctuation">..</span><span class="token punctuation">..</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>lock å‰ç¼€çš„æŒ‡ä»¤åœ¨å¤šæ ¸å¤„ç†å™¨ä¸‹ä¼šå¼•å‘ä¸¤ä»¶äº‹æƒ…:</p><ul><li>å°†å½“å‰å¤„ç†å™¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚</li><li>å†™å›å†…å­˜çš„æ“ä½œä¼šä½¿åœ¨å…¶ä»– CPU é‡Œç¼“å­˜äº†è¯¥å†…å­˜åœ°å€çš„æ•°æ®æ— æ•ˆã€‚</li></ul><p>ä¸ºäº†æé«˜å¤„ç†é€Ÿåº¦ï¼Œå¤„ç†å™¨ä¸ç›´æ¥å’Œå†…å­˜è¿›è¡Œé€šä¿¡ï¼Œè€Œæ˜¯å…ˆå°†ç³»ç»Ÿå†…å­˜çš„æ•°æ®è¯»åˆ°å†…éƒ¨ç¼“å­˜(L1ï¼ŒL2 æˆ–å…¶ä»–)åå†è¿›è¡Œæ“ä½œï¼Œä½†æ“ä½œå®Œä¸çŸ¥é“ä½•æ—¶ä¼šå†™åˆ°å†…å­˜ã€‚</p><p>å¦‚æœå¯¹å£°æ˜äº† volatile çš„å˜é‡è¿›è¡Œå†™æ“ä½œï¼ŒJVM å°±ä¼šå‘å¤„ç†å™¨å‘é€ä¸€æ¡ lock å‰ç¼€çš„æŒ‡ä»¤ï¼Œå°†è¿™ä¸ªå˜é‡æ‰€åœ¨ç¼“å­˜è¡Œçš„æ•°æ®å†™å›åˆ°ç³»ç»Ÿå†…å­˜ã€‚</p><p>ä¸ºäº†ä¿è¯å„ä¸ªå¤„ç†å™¨çš„ç¼“å­˜æ˜¯ä¸€è‡´çš„ï¼Œå®ç°äº†ç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)ï¼Œæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜çš„å€¼æ˜¯ä¸æ˜¯è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±ç¼“å­˜è¡Œå¯¹åº”çš„å†…å­˜åœ°å€è¢«ä¿®æ”¹ï¼Œå°±ä¼šå°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®æˆæ— æ•ˆçŠ¶æ€ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œä¿®æ”¹æ“ä½œçš„æ—¶å€™ï¼Œä¼šé‡æ–°ä»ç³»ç»Ÿå†…å­˜ä¸­æŠŠæ•°æ®è¯»åˆ°å¤„ç†å™¨ç¼“å­˜é‡Œã€‚</p><p>æ‰€æœ‰å¤šæ ¸å¤„ç†å™¨ä¸‹è¿˜ä¼šå®Œæˆï¼šå½“å¤„ç†å™¨å‘ç°æœ¬åœ°ç¼“å­˜å¤±æ•ˆåï¼Œå°±ä¼šä»å†…å­˜ä¸­é‡è¯»è¯¥å˜é‡æ•°æ®ï¼Œå³å¯ä»¥è·å–å½“å‰æœ€æ–°å€¼ã€‚</p><p>volatile å˜é‡é€šè¿‡è¿™æ ·çš„æœºåˆ¶å°±ä½¿å¾—æ¯ä¸ªçº¿ç¨‹éƒ½èƒ½è·å¾—è¯¥å˜é‡çš„æœ€æ–°å€¼ã€‚</p><h4 id="lock-æŒ‡ä»¤" tabindex="-1"><a class="header-anchor" href="#lock-æŒ‡ä»¤" aria-hidden="true">#</a> lock æŒ‡ä»¤</h4><p>åœ¨ Pentium å’Œæ—©æœŸçš„ IA-32 å¤„ç†å™¨ä¸­ï¼Œlock å‰ç¼€ä¼šä½¿å¤„ç†å™¨æ‰§è¡Œå½“å‰æŒ‡ä»¤æ—¶äº§ç”Ÿä¸€ä¸ª LOCK# ä¿¡å·ï¼Œä¼šå¯¹æ€»çº¿è¿›è¡Œé”å®šï¼Œå…¶å®ƒ CPU å¯¹å†…å­˜çš„è¯»å†™è¯·æ±‚éƒ½ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é”é‡Šæ”¾ã€‚ åæ¥çš„å¤„ç†å™¨ï¼ŒåŠ é”æ“ä½œæ˜¯ç”±é«˜é€Ÿç¼“å­˜é”ä»£æ›¿æ€»çº¿é”æ¥å¤„ç†ã€‚ å› ä¸ºé”æ€»çº¿çš„å¼€é”€æ¯”è¾ƒå¤§ï¼Œé”æ€»çº¿æœŸé—´å…¶ä»– CPU æ²¡æ³•è®¿é—®å†…å­˜ã€‚ è¿™ç§åœºæ™¯å¤šç¼“å­˜çš„æ•°æ®ä¸€è‡´é€šè¿‡ç¼“å­˜ä¸€è‡´æ€§åè®®(MESI)æ¥ä¿è¯ã€‚</p><h4 id="ç¼“å­˜ä¸€è‡´æ€§" tabindex="-1"><a class="header-anchor" href="#ç¼“å­˜ä¸€è‡´æ€§" aria-hidden="true">#</a> ç¼“å­˜ä¸€è‡´æ€§</h4><p>ç¼“å­˜æ˜¯åˆ†æ®µ(line)çš„ï¼Œä¸€ä¸ªæ®µå¯¹åº”ä¸€å—å­˜å‚¨ç©ºé—´ï¼Œç§°ä¹‹ä¸ºç¼“å­˜è¡Œï¼Œå®ƒæ˜¯ CPU ç¼“å­˜ä¸­å¯åˆ†é…çš„æœ€å°å­˜å‚¨å•å…ƒï¼Œå¤§å° 32 å­—èŠ‚ã€64 å­—èŠ‚ã€128 å­—èŠ‚ä¸ç­‰ï¼Œè¿™ä¸ CPU æ¶æ„æœ‰å…³ï¼Œé€šå¸¸æ¥è¯´æ˜¯ 64 å­—èŠ‚ã€‚ LOCK# å› ä¸ºé”æ€»çº¿æ•ˆç‡å¤ªä½ï¼Œå› æ­¤ä½¿ç”¨äº†å¤šç»„ç¼“å­˜ã€‚ ä¸ºäº†ä½¿å…¶è¡Œä¸ºçœ‹èµ·æ¥å¦‚åŒä¸€ç»„ç¼“å­˜é‚£æ ·ã€‚å› è€Œè®¾è®¡äº† ç¼“å­˜ä¸€è‡´æ€§åè®®ã€‚ ç¼“å­˜ä¸€è‡´æ€§åè®®æœ‰å¤šç§ï¼Œä½†æ˜¯æ—¥å¸¸å¤„ç†çš„å¤§å¤šæ•°è®¡ç®—æœºè®¾å¤‡éƒ½å±äº &quot; å—…æ¢(snooping)&quot; åè®®ã€‚ æ‰€æœ‰å†…å­˜çš„ä¼ è¾“éƒ½å‘ç”Ÿåœ¨ä¸€æ¡å…±äº«çš„æ€»çº¿ä¸Šï¼Œè€Œæ‰€æœ‰çš„å¤„ç†å™¨éƒ½èƒ½çœ‹åˆ°è¿™æ¡æ€»çº¿ã€‚ ç¼“å­˜æœ¬èº«æ˜¯ç‹¬ç«‹çš„ï¼Œä½†æ˜¯å†…å­˜æ˜¯å…±äº«èµ„æºï¼Œæ‰€æœ‰çš„å†…å­˜è®¿é—®éƒ½è¦ç»è¿‡ä»²è£(åŒä¸€ä¸ªæŒ‡ä»¤å‘¨æœŸä¸­ï¼Œåªæœ‰ä¸€ä¸ª CPU ç¼“å­˜å¯ä»¥è¯»å†™å†…å­˜)ã€‚ CPU ç¼“å­˜ä¸ä»…ä»…åœ¨åšå†…å­˜ä¼ è¾“çš„æ—¶å€™æ‰ä¸æ€»çº¿æ‰“äº¤é“ï¼Œè€Œæ˜¯ä¸åœåœ¨å—…æ¢æ€»çº¿ä¸Šå‘ç”Ÿçš„æ•°æ®äº¤æ¢ï¼Œè·Ÿè¸ªå…¶ä»–ç¼“å­˜åœ¨åšä»€ä¹ˆã€‚ å½“ä¸€ä¸ªç¼“å­˜ä»£è¡¨å®ƒæ‰€å±çš„å¤„ç†å™¨å»è¯»å†™å†…å­˜æ—¶ï¼Œå…¶å®ƒå¤„ç†å™¨éƒ½ä¼šå¾—åˆ°é€šçŸ¥ï¼Œå®ƒä»¬ä»¥æ­¤æ¥ä½¿è‡ªå·±çš„ç¼“å­˜ä¿æŒåŒæ­¥ã€‚ åªè¦æŸä¸ªå¤„ç†å™¨å†™å†…å­˜ï¼Œå…¶å®ƒå¤„ç†å™¨é©¬ä¸ŠçŸ¥é“è¿™å—å†…å­˜åœ¨å®ƒä»¬çš„ç¼“å­˜æ®µä¸­å·²ç»å¤±æ•ˆã€‚</p><h3 id="_2-volatile-æœ‰åºæ€§å®ç°" tabindex="-1"><a class="header-anchor" href="#_2-volatile-æœ‰åºæ€§å®ç°" aria-hidden="true">#</a> 2.volatile æœ‰åºæ€§å®ç°</h3><h4 id="volatile-çš„-happens-before-å…³ç³»" tabindex="-1"><a class="header-anchor" href="#volatile-çš„-happens-before-å…³ç³»" aria-hidden="true">#</a> volatile çš„ happens-before å…³ç³»</h4><p>happens-before è§„åˆ™ä¸­æœ‰ä¸€æ¡æ˜¯ volatile å˜é‡è§„åˆ™ï¼šå¯¹ä¸€ä¸ª volatile åŸŸçš„å†™ï¼Œhappens-before äºä»»æ„åç»­å¯¹è¿™ä¸ª volatile åŸŸçš„è¯»ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//å‡è®¾çº¿ç¨‹Aæ‰§è¡Œwriteræ–¹æ³•ï¼Œçº¿ç¨‹Bæ‰§è¡Œreaderæ–¹æ³•</span>
<span class="token keyword">class</span> <span class="token class-name">VolatileExample</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> flag <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">writer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>              <span class="token comment">// 1 çº¿ç¨‹Aä¿®æ”¹å…±äº«å˜é‡</span>
        flag <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token comment">// 2 çº¿ç¨‹Aå†™volatileå˜é‡</span>
    <span class="token punctuation">}</span> 
    
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">reader</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>flag<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">// 3 çº¿ç¨‹Bè¯»åŒä¸€ä¸ªvolatileå˜é‡</span>
        <span class="token keyword">int</span> i <span class="token operator">=</span> a<span class="token punctuation">;</span>          <span class="token comment">// 4 çº¿ç¨‹Bè¯»å…±äº«å˜é‡</span>
        â€¦â€¦
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ ¹æ® happens-before è§„åˆ™ï¼Œä¸Šé¢è¿‡ç¨‹ä¼šå»ºç«‹ 3 ç±» happens-before å…³ç³»ã€‚</p><ul><li>æ ¹æ®ç¨‹åºæ¬¡åºè§„åˆ™ï¼š1 happens-before 2 ä¸” 3 happens-before 4ã€‚</li><li>æ ¹æ® volatile è§„åˆ™ï¼š2 happens-before 3ã€‚</li><li>æ ¹æ® happens-before çš„ä¼ é€’æ€§è§„åˆ™ï¼š1 happens-before 4ã€‚</li></ul><p><img src="https://raw.githubusercontent.com/huluhutu/blogimg/main/img/image-20220930110412339.png" alt="image-20220930110412339" loading="lazy"></p><p>å› ä¸ºä»¥ä¸Šè§„åˆ™ï¼Œå½“çº¿ç¨‹ A å°† volatile å˜é‡ flag æ›´æ”¹ä¸º true åï¼Œçº¿ç¨‹ B èƒ½å¤Ÿè¿…é€Ÿæ„ŸçŸ¥ã€‚</p><h4 id="volatile-ç¦æ­¢é‡æ’åº" tabindex="-1"><a class="header-anchor" href="#volatile-ç¦æ­¢é‡æ’åº" aria-hidden="true">#</a> volatile ç¦æ­¢é‡æ’åº</h4><p>ä¸ºäº†æ€§èƒ½ä¼˜åŒ–ï¼ŒJMM åœ¨ä¸æ”¹å˜æ­£ç¡®è¯­ä¹‰çš„å‰æä¸‹ï¼Œä¼šå…è®¸ç¼–è¯‘å™¨å’Œå¤„ç†å™¨å¯¹æŒ‡ä»¤åºåˆ—è¿›è¡Œé‡æ’åºã€‚JMM æä¾›äº†å†…å­˜å±éšœé˜»æ­¢è¿™ç§é‡æ’åºã€‚</p><p>Java ç¼–è¯‘å™¨ä¼šåœ¨ç”ŸæˆæŒ‡ä»¤ç³»åˆ—æ—¶åœ¨é€‚å½“çš„ä½ç½®ä¼šæ’å…¥å†…å­˜å±éšœæŒ‡ä»¤æ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p><p>JMM ä¼šé’ˆå¯¹ç¼–è¯‘å™¨åˆ¶å®š volatile é‡æ’åºè§„åˆ™è¡¨ã€‚</p><p><img src="https://raw.githubusercontent.com/huluhutu/blogimg/main/img/image-20220930111052247.png" alt="image-20220930111052247" loading="lazy"></p><p>&quot; NO &quot; è¡¨ç¤ºç¦æ­¢é‡æ’åºã€‚</p><p>ä¸ºäº†å®ç° volatile å†…å­˜è¯­ä¹‰æ—¶ï¼Œç¼–è¯‘å™¨åœ¨ç”Ÿæˆå­—èŠ‚ç æ—¶ï¼Œä¼šåœ¨æŒ‡ä»¤åºåˆ—ä¸­æ’å…¥å†…å­˜å±éšœæ¥ç¦æ­¢ç‰¹å®šç±»å‹çš„å¤„ç†å™¨é‡æ’åºã€‚</p><p>å¯¹äºç¼–è¯‘å™¨æ¥è¯´ï¼Œå‘ç°ä¸€ä¸ªæœ€ä¼˜å¸ƒç½®æ¥æœ€å°åŒ–æ’å…¥å±éšœçš„æ€»æ•°å‡ ä¹æ˜¯ä¸å¯èƒ½çš„ï¼Œä¸ºæ­¤ï¼ŒJMM é‡‡å–äº†ä¿å®ˆçš„ç­–ç•¥ã€‚</p><ul><li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„å‰é¢æ’å…¥ä¸€ä¸ª StoreStore å±éšœã€‚</li><li>åœ¨æ¯ä¸ª volatile å†™æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª StoreLoad å±éšœã€‚</li><li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadLoad å±éšœã€‚</li><li>åœ¨æ¯ä¸ª volatile è¯»æ“ä½œçš„åé¢æ’å…¥ä¸€ä¸ª LoadStore å±éšœã€‚</li></ul><p>volatile å†™æ˜¯åœ¨å‰é¢å’Œåé¢åˆ†åˆ«æ’å…¥å†…å­˜å±éšœï¼Œè€Œ volatile è¯»æ“ä½œæ˜¯åœ¨åé¢æ’å…¥ä¸¤ä¸ªå†…å­˜å±éšœã€‚</p><table><thead><tr><th>å†…å­˜å±éšœ</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>StoreStore å±éšœ</td><td>ç¦æ­¢ä¸Šé¢çš„æ™®é€šå†™å’Œä¸‹é¢çš„ volatile å†™é‡æ’åºã€‚</td></tr><tr><td>StoreLoad å±éšœ</td><td>é˜²æ­¢ä¸Šé¢çš„ volatile å†™ä¸ä¸‹é¢å¯èƒ½æœ‰çš„ volatile è¯»/å†™é‡æ’åºã€‚</td></tr><tr><td>LoadLoad å±éšœ</td><td>ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šè¯»æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚</td></tr><tr><td>LoadStore å±éšœ</td><td>ç¦æ­¢ä¸‹é¢æ‰€æœ‰çš„æ™®é€šå†™æ“ä½œå’Œä¸Šé¢çš„ volatile è¯»é‡æ’åºã€‚</td></tr></tbody></table><p><img src="https://raw.githubusercontent.com/huluhutu/blogimg/main/img/image-20220930111126541.png" alt="image-20220930111126541" loading="lazy"></p><p><img src="https://pdai.tech/_images/thread/java-thread-x-key-volatile-4.png" alt="img" loading="lazy"></p><h2 id="_3-volatileåº”ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#_3-volatileåº”ç”¨åœºæ™¯" aria-hidden="true">#</a> 3-volatileåº”ç”¨åœºæ™¯</h2><p>ä½¿ç”¨ volatile å¿…é¡»å…·å¤‡çš„æ¡ä»¶</p><ul><li>å¯¹å˜é‡çš„å†™æ“ä½œä¸ä¾èµ–äºå½“å‰å€¼ã€‚</li><li>è¯¥å˜é‡æ²¡æœ‰åŒ…å«åœ¨å…·æœ‰å…¶ä»–å˜é‡çš„ä¸å˜å¼ä¸­ã€‚</li><li>åªæœ‰åœ¨çŠ¶æ€çœŸæ­£ç‹¬ç«‹äºç¨‹åºå†…å…¶ä»–å†…å®¹æ—¶æ‰èƒ½ä½¿ç”¨ volatileã€‚</li></ul><h3 id="æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼1-çŠ¶æ€æ ‡å¿—" aria-hidden="true">#</a> æ¨¡å¼1ï¼šçŠ¶æ€æ ‡å¿—</h3><p>ä¹Ÿè®¸å®ç° volatile å˜é‡çš„è§„èŒƒä½¿ç”¨ä»…ä»…æ˜¯ä½¿ç”¨ä¸€ä¸ªå¸ƒå°”çŠ¶æ€æ ‡å¿—ï¼Œç”¨äºæŒ‡ç¤ºå‘ç”Ÿäº†ä¸€ä¸ªé‡è¦çš„ä¸€æ¬¡æ€§äº‹ä»¶ï¼Œä¾‹å¦‚å®Œæˆåˆå§‹åŒ–æˆ–è¯·æ±‚åœæœºã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">volatile</span> <span class="token keyword">boolean</span> shutdownRequested<span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">shutdown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> shutdownRequested <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>shutdownRequested<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token comment">// do stuff</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼2-ä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ-one-time-safe-publication" aria-hidden="true">#</a> æ¨¡å¼2ï¼šä¸€æ¬¡æ€§å®‰å…¨å‘å¸ƒ(one-time safe publication)</h3><p>ç¼ºä¹åŒæ­¥ä¼šå¯¼è‡´æ— æ³•å®ç°å¯è§æ€§ï¼Œè¿™ä½¿å¾—ç¡®å®šä½•æ—¶å†™å…¥å¯¹è±¡å¼•ç”¨è€Œä¸æ˜¯åŸå§‹å€¼å˜å¾—æ›´åŠ å›°éš¾ã€‚åœ¨ç¼ºä¹åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šé‡åˆ°æŸä¸ªå¯¹è±¡å¼•ç”¨çš„æ›´æ–°å€¼(ç”±å¦ä¸€ä¸ªçº¿ç¨‹å†™å…¥)å’Œè¯¥å¯¹è±¡çŠ¶æ€çš„æ—§å€¼åŒæ—¶å­˜åœ¨ã€‚(è¿™å°±æ˜¯é€ æˆè‘—åçš„åŒé‡æ£€æŸ¥é”å®š(double-checked-locking)é—®é¢˜çš„æ ¹æºï¼Œå…¶ä¸­å¯¹è±¡å¼•ç”¨åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹è¿›è¡Œè¯»æ“ä½œï¼Œäº§ç”Ÿçš„é—®é¢˜æ˜¯æ‚¨å¯èƒ½ä¼šçœ‹åˆ°ä¸€ä¸ªæ›´æ–°çš„å¼•ç”¨ï¼Œä½†æ˜¯ä»ç„¶ä¼šé€šè¿‡è¯¥å¼•ç”¨çœ‹åˆ°ä¸å®Œå…¨æ„é€ çš„å¯¹è±¡)ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BackgroundFloobleLoader</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token class-name">Flooble</span> theFlooble<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initInBackground</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// do lots of stuff</span>
        theFlooble <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Flooble</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// this is the only write to theFlooble</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
 
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SomeOtherClass</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">doWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
            <span class="token comment">// do some stuff...</span>
            <span class="token comment">// use the Flooble, but only if it is ready</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>floobleLoader<span class="token punctuation">.</span>theFlooble <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> 
                <span class="token function">doSomething</span><span class="token punctuation">(</span>floobleLoader<span class="token punctuation">.</span>theFlooble<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼3-ç‹¬ç«‹è§‚å¯Ÿ-independent-observation" aria-hidden="true">#</a> æ¨¡å¼3ï¼šç‹¬ç«‹è§‚å¯Ÿ(independent observation)</h3><p>å®‰å…¨ä½¿ç”¨ volatile çš„å¦ä¸€ç§ç®€å•æ¨¡å¼æ˜¯å®šæœŸ å‘å¸ƒ è§‚å¯Ÿç»“æœä¾›ç¨‹åºå†…éƒ¨ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼Œå‡è®¾æœ‰ä¸€ç§ç¯å¢ƒä¼ æ„Ÿå™¨èƒ½å¤Ÿæ„Ÿè§‰ç¯å¢ƒæ¸©åº¦ã€‚ä¸€ä¸ªåå°çº¿ç¨‹å¯èƒ½ä¼šæ¯éš”å‡ ç§’è¯»å–ä¸€æ¬¡è¯¥ä¼ æ„Ÿå™¨ï¼Œå¹¶æ›´æ–°åŒ…å«å½“å‰æ–‡æ¡£çš„ volatile å˜é‡ã€‚ç„¶åï¼Œå…¶ä»–çº¿ç¨‹å¯ä»¥è¯»å–è¿™ä¸ªå˜é‡ï¼Œä»è€Œéšæ—¶èƒ½å¤Ÿçœ‹åˆ°æœ€æ–°çš„æ¸©åº¦å€¼ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserManager</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> lastUser<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">authenticate</span><span class="token punctuation">(</span><span class="token class-name">String</span> user<span class="token punctuation">,</span> <span class="token class-name">String</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">boolean</span> valid <span class="token operator">=</span> <span class="token function">passwordIsValid</span><span class="token punctuation">(</span>user<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>valid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">User</span> u <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            activeUsers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>u<span class="token punctuation">)</span><span class="token punctuation">;</span>
            lastUser <span class="token operator">=</span> user<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> valid<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡å¼4-volatile-bean-æ¨¡å¼" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼4-volatile-bean-æ¨¡å¼" aria-hidden="true">#</a> æ¨¡å¼4ï¼švolatile bean æ¨¡å¼</h3><p>åœ¨ volatile bean æ¨¡å¼ä¸­ï¼ŒJavaBean çš„æ‰€æœ‰æ•°æ®æˆå‘˜éƒ½æ˜¯ volatile ç±»å‹çš„ï¼Œå¹¶ä¸” getter å’Œ setter æ–¹æ³•å¿…é¡»éå¸¸æ™®é€š â€”â€” é™¤äº†è·å–æˆ–è®¾ç½®ç›¸åº”çš„å±æ€§å¤–ï¼Œä¸èƒ½åŒ…å«ä»»ä½•é€»è¾‘ã€‚æ­¤å¤–ï¼Œå¯¹äºå¯¹è±¡å¼•ç”¨çš„æ•°æ®æˆå‘˜ï¼Œå¼•ç”¨çš„å¯¹è±¡å¿…é¡»æ˜¯æœ‰æ•ˆä¸å¯å˜çš„ã€‚(è¿™å°†ç¦æ­¢å…·æœ‰æ•°ç»„å€¼çš„å±æ€§ï¼Œå› ä¸ºå½“æ•°ç»„å¼•ç”¨è¢«å£°æ˜ä¸º volatile æ—¶ï¼Œåªæœ‰å¼•ç”¨è€Œä¸æ˜¯æ•°ç»„æœ¬èº«å…·æœ‰ volatile è¯­ä¹‰)ã€‚å¯¹äºä»»ä½• volatile å˜é‡ï¼Œä¸å˜å¼æˆ–çº¦æŸéƒ½ä¸èƒ½åŒ…å« JavaBean å±æ€§ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> firstName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> lastName<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getFirstName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> firstName<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getLastName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> lastName<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> age<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setFirstName</span><span class="token punctuation">(</span><span class="token class-name">String</span> firstName<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>firstName <span class="token operator">=</span> firstName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLastName</span><span class="token punctuation">(</span><span class="token class-name">String</span> lastName<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>lastName <span class="token operator">=</span> lastName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span> 
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼5-å¼€é”€è¾ƒä½çš„è¯»-å†™é”ç­–ç•¥" aria-hidden="true">#</a> æ¨¡å¼5ï¼šå¼€é”€è¾ƒä½çš„è¯»ï¼å†™é”ç­–ç•¥</h3><p>volatile çš„åŠŸèƒ½è¿˜ä¸è¶³ä»¥å®ç°è®¡æ•°å™¨ã€‚å› ä¸º ++x å®é™…ä¸Šæ˜¯ä¸‰ç§æ“ä½œ(è¯»ã€æ·»åŠ ã€å­˜å‚¨)çš„ç®€å•ç»„åˆï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹å‡‘å·§è¯•å›¾åŒæ—¶å¯¹ volatile è®¡æ•°å™¨æ‰§è¡Œå¢é‡æ“ä½œï¼Œé‚£ä¹ˆå®ƒçš„æ›´æ–°å€¼æœ‰å¯èƒ½ä¼šä¸¢å¤±ã€‚ å¦‚æœè¯»æ“ä½œè¿œè¿œè¶…è¿‡å†™æ“ä½œï¼Œå¯ä»¥ç»“åˆä½¿ç”¨å†…éƒ¨é”å’Œ volatile å˜é‡æ¥å‡å°‘å…¬å…±ä»£ç è·¯å¾„çš„å¼€é”€ã€‚ å®‰å…¨çš„è®¡æ•°å™¨ä½¿ç”¨ synchronized ç¡®ä¿å¢é‡æ“ä½œæ˜¯åŸå­çš„ï¼Œå¹¶ä½¿ç”¨ volatile ä¿è¯å½“å‰ç»“æœçš„å¯è§æ€§ã€‚å¦‚æœæ›´æ–°ä¸é¢‘ç¹çš„è¯ï¼Œè¯¥æ–¹æ³•å¯å®ç°æ›´å¥½çš„æ€§èƒ½ï¼Œå› ä¸ºè¯»è·¯å¾„çš„å¼€é”€ä»…ä»…æ¶‰åŠ volatile è¯»æ“ä½œï¼Œè¿™é€šå¸¸è¦ä¼˜äºä¸€ä¸ªæ— ç«äº‰çš„é”è·å–çš„å¼€é”€ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ThreadSafe</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheesyCounter</span> <span class="token punctuation">{</span>
    <span class="token comment">// Employs the cheap read-write lock trick</span>
    <span class="token comment">// All mutative operations MUST be done with the &#39;this&#39; lock held</span>
    <span class="token annotation punctuation">@GuardedBy</span><span class="token punctuation">(</span><span class="token string">&quot;this&quot;</span><span class="token punctuation">)</span> <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>
 
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>
 
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> value<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" tabindex="-1"><a class="header-anchor" href="#æ¨¡å¼6-åŒé‡æ£€æŸ¥-double-checked" aria-hidden="true">#</a> æ¨¡å¼6ï¼šåŒé‡æ£€æŸ¥(double-checked</h3><p>å°±æ˜¯æˆ‘ä»¬ä¸Šæ–‡ä¸¾çš„ä¾‹å­ã€‚</p><p>å•ä¾‹æ¨¡å¼çš„ä¸€ç§å®ç°æ–¹å¼ï¼Œä½†å¾ˆå¤šäººä¼šå¿½ç•¥ volatile å…³é”®å­—ï¼Œå› ä¸ºæ²¡æœ‰è¯¥å…³é”®å­—ï¼Œç¨‹åºä¹Ÿå¯ä»¥å¾ˆå¥½çš„è¿è¡Œï¼Œåªä¸è¿‡ä»£ç çš„ç¨³å®šæ€§æ€»ä¸æ˜¯ 100%ï¼Œè¯´ä¸å®šåœ¨æœªæ¥çš„æŸä¸ªæ—¶åˆ»ï¼Œéšè—çš„ bug å°±å‡ºæ¥äº†ã€‚</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">class</span> <span class="token class-name">Singleton</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> instance<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">Singleton</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">syschronized</span><span class="token punctuation">(</span><span class="token class-name">Singleton</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Singleton</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-æ€è€ƒ" tabindex="-1"><a class="header-anchor" href="#_4-æ€è€ƒ" aria-hidden="true">#</a> 4-æ€è€ƒ</h2><ul><li>volatileå…³é”®å­—çš„ä½œç”¨æ˜¯ä»€ä¹ˆ?</li><li>volatileèƒ½ä¿è¯åŸå­æ€§å—?</li><li>ä¹‹å‰32ä½æœºå™¨ä¸Šå…±äº«çš„longå’Œdoubleå˜é‡çš„ä¸ºä»€ä¹ˆè¦ç”¨volatile? ç°åœ¨64ä½æœºå™¨ä¸Šæ˜¯å¦ä¹Ÿè¦è®¾ç½®å‘¢?</li><li>i++ä¸ºä»€ä¹ˆä¸èƒ½ä¿è¯åŸå­æ€§?</li><li>volatileæ˜¯å¦‚ä½•å®ç°å¯è§æ€§çš„? å†…å­˜å±éšœã€‚</li><li>volatileæ˜¯å¦‚ä½•å®ç°æœ‰åºæ€§çš„? happens-beforeç­‰</li><li>è¯´ä¸‹volatileçš„åº”ç”¨åœºæ™¯?</li></ul></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/docs/pages/Java/JavaConcurrent/4-valatile.md" rel="noopener noreferrer" target="_blank" aria-label="åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->åœ¨ GitHub ä¸Šç¼–è¾‘æ­¤é¡µ<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="meta-item contributors"><span class="label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="contributor" title="email: 842830066@qq.com">huluhutu</span><!--]--><!--]--></div></footer><nav class="page-nav"><a href="/huluhutublog/pages/Java/JavaConcurrent/3-Synchronized.html" class="nav-link prev" aria-label="Synchronized"><div class="hint"><span class="arrow left"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->Synchronized</div></a><a href="/huluhutublog/pages/Java/JavaConcurrent/5-final.html" class="nav-link next" aria-label="final"><div class="hint">ä¸‹ä¸€é¡µ<span class="arrow right"></span></div><div class="link">final<!----></div></a></nav><div class="giscus-wrapper input-top" style="display:block;"><div style="text-align:center">Loading...</div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">é»˜è®¤é¡µè„š</div><div class="copyright">Copyright Â© 2022 huluhutu</div></footer><!--]--></div><!--]--><!----><!----><!--]--></div>
    <script type="module" src="/huluhutublog/assets/app.0662e65c.js" defer></script>
  </body>
</html>
